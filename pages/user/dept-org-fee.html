<head>
  <title>Manage Department Org Fee</title>
  <style>
    /* Match manage-announcement / event-expenses read-only style */
    #dfReadOnlyBadge {
      font-size: 0.75rem;
    }
    .disabled-action {
      opacity: 0.4 !important;
      pointer-events: none !important;
    }

    .org-card{cursor:pointer;transition:transform .08s ease}
    .org-card:hover{transform:translateY(-2px)}
    .badge-status{font-size:.8rem}
    .tab-pane{padding-top:1rem}
    .kpi{min-width:190px}
    .org-name, .org-sub{display:block;max-width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    @media print {
      .no-print{display:none !important}
      #printArea{display:block !important}
      .tab-pane{padding-top:0}
      body{background:#fff}
      .card{box-shadow:none;border:0}
    }

    @media (min-width: 992px){
      #dept-fees .filters-row .form-label.text-nowrap { white-space: nowrap; }
      #dept-fees .filters-row > [class*="col-"] { display:flex; flex-direction:column; }
      #dept-fees .filters-row .form-select, #dept-fees .filters-row .btn { margin-top:auto; }
    }

    #dept-fees .org-card .card-body { overflow: hidden; }

    /* Typeahead dropdowns */
    .suggest-wrap { position: relative; }
    #treasurerSuggest, #paySuggest {
      position: absolute;
      left: 0; right: 0; top: 100%;
      z-index: 20;
      max-height: 260px;
      overflow: auto;
    }
  </style>
</head>

<div id="dept-fees" class="container-fluid">
  <!-- Top header -->
  <div class="d-flex align-items-center justify-content-between mb-2">
    <div class="d-flex flex-column">
      <h1 class="mb-0">DEPARTMENT ORG FEES</h1>
      <span id="dfReadOnlyBadge" class="text-muted d-none">
      Other Academic Year/ Semester (you can still add payments if it's available)
      </span>
      <small class="text-muted" style="display: none;">Manage department-exclusive org fees, treasurers, payments, and reports.</small>
    </div>
    <div class="text-end small">
      <div class="mb-1">
        <span class="text-muted" style="display: none;">Module:</span>
        <span class="badge bg-secondary" style="display: none;">Finance / Org Fees</span>
      </div>
      <div class="mb-1">
        <span class="text-muted" style="display: none;">Current Academic Year:</span>
        <span id="headerAYSpan" class="badge bg-primary" style="display: none;">—</span>
      </div>
    </div>
  </div>

  <!-- Filters row -->
  <div class="d-flex justify-content-end gap-3 mt-2 flex-wrap no-print filters-row">
    <div class="d-flex gap-2 align-items-center">
      <span class="text-muted">School Year:</span>
      <select id="aySpanSelect" class="form-select form-select-sm" style="width:auto; min-width:140px;"></select>
    </div>
    <div class="d-flex gap-2 align-items-center">
      <span class="text-muted">Semester:</span>
      <select id="activeYearSelect" class="form-select form-select-sm" style="width:auto; min-width:110px;"></select>
    </div>
    <button id="refreshBtn" class="btn btn-outline-secondary btn-sm" style="display: none;">
      <i class="bi bi-arrow-repeat me-1"></i>Refresh
    </button>
  </div>

  <!-- Main card -->
  <div class="card shadow-sm border-0 mt-3">
    <div class="card-body">
      <!-- GRID VIEW -->
      <div id="gridView">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
          <input
            id="orgSearch"
            type="search"
            class="form-control"
            style="max-width: 420px;"
            placeholder="Search department organizations by name, abbreviation, course…"
          >
          <span class="text-muted small">
            Select an organization card to manage its fee and payments.
          </span>
        </div>

        <!-- Cards grid -->
        <div id="orgGrid" class="row g-3"></div>

        <!-- Empty state -->
        <div id="emptyState" class="text-center text-muted py-5 d-none">
          <div class="mb-2">
            <i class="bi bi-box-seam fs-1 text-secondary"></i>
          </div>
          <p class="mb-1">No organizations for the selected academic year.</p>
          <p class="small mb-0">Try changing the Academic Year filters or your search.</p>
        </div>
      </div>

      <!-- DETAIL VIEW -->
      <div id="detailView" class="d-none mt-2">
        <!-- Header -->
        <div class="d-flex align-items-center gap-2 mb-3">
          <button id="backToGrid" class="btn btn-outline-secondary btn-sm no-print">
            <i class="bi bi-arrow-left"></i> Back
          </button>
          <div>
            <h6 id="orgTitle" class="mb-0">—</h6>
            <div class="text-muted small" id="orgSubtitle">—</div>
          </div>
          <span id="orgStatusBadge" class="badge text-bg-secondary badge-status ms-2">—</span>
          <div class="ms-auto small text-muted">
            AY: <span id="headerAY">—</span>
          </div>
        </div>

        <!-- FULL-WIDTH TABS (Org Info Removed) -->
        <div class="card shadow-sm border-0">
          <div class="card-body">
            <!-- Tabs -->
            <ul class="nav nav-pills no-print" id="orgTabs" role="tablist">
              <li class="nav-item">
                <button class="nav-link" style="display: none;" data-bs-toggle="pill" data-bs-target="#tab-fee" type="button">
                  <i class="bi bi-cash-coin me-1"></i>Set Fee & Treasurer
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-paid" type="button">
                  <i class="bi bi-person-check me-1"></i>Paid Users
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-unpaid" type="button">
                  <i class="bi bi-person-x me-1"></i>Unpaid Users
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-reports" type="button">
                  <i class="bi bi-graph-up-arrow me-1"></i>Reports
                </button>
              </li>
            </ul>

            <div class="tab-content">
              <!-- Set Fee & Treasurer -->
              <div class="tab-pane fade" id="tab-fee">
                <div id="feeAlert" class="alert alert-info d-none"></div>
                <form id="feeForm" class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Fee Title</label>
                    <input type="text" class="form-control" id="feeTitle" placeholder="Department Org Fee" required>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Amount</label>
                    <input type="number" step="0.01" min="0" class="form-control" id="feeAmount" required>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Currency</label>
                    <input type="text" class="form-control" id="feeCurrency" value="PHP" maxlength="3">
                  </div>
                  <div class="col-12">
                    <label class="form-label">Description (optional)</label>
                    <textarea class="form-control" id="feeDescription" rows="2"></textarea>
                  </div>

                  <div class="col-12">
                    <label class="form-label">Treasurer (Student)</label>
                    <div class="suggest-wrap">
                      <input type="text" class="form-control" id="treasurerName" placeholder="Search by name or ID… (Pick from suggestions)" autocomplete="off" required>
                      <input type="hidden" id="treasurerIdHidden">
                      <div id="treasurerSuggest" class="list-group shadow-sm d-none"></div>
                    </div>
                    <div class="form-text">
                      Shown value is the student's name; the submission stores the student's <code>id_number</code>.
                    </div>
                  </div>

                  <div class="col-12">
                    <button id="saveFeeBtn" type="submit" class="btn btn-primary">
                      <i class="bi bi-save me-1"></i>Save / Update
                    </button>
                  </div>
                </form>

                <div class="mt-4">
                  <div class="small text-muted">Current fee for this org &amp; semester:</div>
                  <div id="currentFeeSummary" class="mt-1">—</div>
                </div>
              </div>

              <!-- Paid Users -->
              <div class="tab-pane fade show active" id="tab-paid">
                <div class="d-flex flex-wrap gap-2 align-items-center mb-2 no-print">
                  <div class="input-group" style="max-width:280px">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input id="paidSearch" type="search" class="form-control" placeholder="Search paid by ID, receipt…">
                  </div>
                  <button id="addPaymentBtn" class="btn btn-outline-primary">
                    <i class="bi bi-plus-circle me-1"></i>Record Payment
                  </button>
                  <button id="exportPaidBtn" type="button" class="btn btn-outline-secondary">
                    <i class="bi bi-download me-1"></i>Export CSV
                  </button>
                  <button id="printPaidBtn" type="button" class="btn btn-outline-secondary">
                    <i class="bi bi-printer me-1"></i>Print Paid List
                  </button>
                </div>

                <div class="table-responsive">
                  <table class="table table-sm align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>Receipt</th>
                        <th>Payer ID</th>
                        <th>Name</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Paid On</th>
                        <th>Course</th>
                        <th>School Year</th>
                        <th>Year Level</th>
                        <th class="no-print text-end">Actions</th>
                      </tr>
                    </thead>
                    <tbody id="paidTbody">
                      <tr><td colspan="10" class="text-muted">—</td></tr>
                    </tbody>
                  </table>
                </div>
                
                <!-- Paid Pagination -->
                <div id="paidPagination" class="d-flex justify-content-between align-items-center mt-3"></div>
              </div>

              <!-- Unpaid Users -->
              <div class="tab-pane fade" id="tab-unpaid">
                <div class="small text-muted mb-2">
                  Unpaid = Students in this department (selected semester) without a confirmed payment for this fee.
                </div>

                <div class="d-flex flex-wrap gap-2 mb-2 no-print">
                  <div class="input-group" style="max-width:280px">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input id="unpaidSearch" type="search" class="form-control" placeholder="Search by ID or name">
                  </div>
                  <button id="exportUnpaidBtn" class="btn btn-outline-secondary">
                    <i class="bi bi-download me-1"></i>Export CSV
                  </button>
                  <button id="printUnpaidBtn" type="button" class="btn btn-outline-secondary">
                    <i class="bi bi-printer me-1"></i>Print Unpaid List
                  </button>
                </div>

                <div class="table-responsive">
                  <table class="table table-sm align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>ID Number</th>
                        <th>Name</th>
                        <th>Year Level</th>
                        <th>Course</th>
                      </tr>
                    </thead>
                    <tbody id="unpaidTbody">
                      <tr><td colspan="4" class="text-muted">—</td></tr>
                    </tbody>
                  </table>
                </div>
                
                <!-- Unpaid Pagination -->
                <div id="unpaidPagination" class="d-flex justify-content-between align-items-center mt-3"></div>
              </div>

              <!-- Reports -->
              <div class="tab-pane fade" id="tab-reports">
                <div class="d-flex flex-wrap gap-3">
                  <div class="card kpi">
                    <div class="card-body">
                      <div class="text-muted small">Paid Today</div>
                      <div id="kpiToday" class="fs-4">0</div>
                    </div>
                  </div>
                  <div class="card kpi">
                    <div class="card-body">
                      <div class="text-muted small">Paid This Week</div>
                      <div id="kpiWeek" class="fs-4">0</div>
                    </div>
                  </div>
                  <div class="card kpi">
                    <div class="card-body">
                      <div class="text-muted small">Paid This Month</div>
                      <div id="kpiMonth" class="fs-4">0</div>
                    </div>
                  </div>
                  <div class="card kpi">
                    <div class="card-body">
                      <div class="text-muted small">Paid This Semester</div>
                      <div id="kpiSemester" class="fs-4">0</div>
                    </div>
                  </div>
                  <div class="card kpi">
                    <div class="card-body">
                      <div class="text-muted small">Unpaid (Dept)</div>
                      <div id="kpiUnpaid" class="fs-4">0</div>
                    </div>
                  </div>
                </div>

                <div class="mt-3 no-print">
                  <button id="printBtn" class="btn btn-secondary">
                    <i class="bi bi-printer me-1"></i>Print Reports
                  </button>
                </div>

                <!-- Printable Summary -->
                <div id="printArea" class="mt-3 d-none">
                  <h5 class="mb-1">Department Org Fee — Receipt Summary</h5>
                  <div class="text-muted mb-3">
                    Org: <span id="printOrgName">—</span> · AY <span id="printAY">—</span> (Active: <span id="printActive">—</span>)
                  </div>

                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead class="table-light">
                        <tr>
                          <th>Date</th>
                          <th>Receipt #</th>
                          <th>Payer ID</th>
                          <th>Name</th>
                          <th class="text-end">Amount</th>
                        </tr>
                      </thead>
                      <tbody id="printPaymentsBody">
                        <tr><td colspan="5" class="text-muted">—</td></tr>
                      </tbody>
                      <tfoot>
                        <tr>
                          <th colspan="4" class="text-end">Total</th>
                          <th class="text-end" id="printTotalAmount">PHP 0.00</th>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>

              </div>
            </div> <!-- /tab-content -->
          </div>
        </div> <!-- /full-width card -->

      </div> <!-- /detailView -->
    </div> <!-- /card-body -->
  </div> <!-- /card -->

  <span style="height: 30px; visibility: hidden;">######</span>
</div>

<!-- Add Payment Modal -->
<div class="modal fade" id="addPaymentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-receipt-cutoff me-1"></i>Record Payment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">

        <div class="mb-3">
          <label class="form-label">Student (payer)</label>
          <div class="position-relative">
            <input id="payerSearchName" type="text" class="form-control" placeholder="Search by name or ID… (Pick from suggestions)" autocomplete="off">
            <input id="payerIdHidden" type="hidden">
            <div id="payerSuggest" class="list-group shadow-sm position-absolute w-100 d-none" style="z-index:1056; max-height: 240px; overflow:auto;"></div>
          </div>
          <div class="form-text">
            Shown value is the student's name; the submission stores the student's <code>id_number</code>.
          </div>
        </div>

        <div class="row g-3">
          <div class="col-sm-6">
            <label class="form-label">Amount</label>
            <input id="payAmount" type="number" step="0.01" min="0" class="form-control" required readonly>
          </div>
          <div class="col-sm-6">
            <label class="form-label">Method</label>
            <select id="payMethod" class="form-select">
              <option value="cash">Cash</option>
              <option value="online">Online</option>
              <option value="other">Other</option>
            </select>
          </div>
        </div>

       <div class="mt-3">
          <label class="form-label">Receipt No.</label>
          <input id="payNote" type="text" class="form-control" maxlength="255" required
                pattern="[0-9\-]*" 
                title="Only numbers and dashes are allowed">
       </div>

      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button id="confirmAddPaymentBtn" class="btn btn-primary">
          <i class="bi bi-check2-circle me-1"></i>Record Payment
        </button>
      </div>
    </div>
  </div>
</div>
<!--display:none-->