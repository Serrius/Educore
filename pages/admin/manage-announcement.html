<head>
  <title>Manage Announcement</title>
  <style>
    .openEditAnnBtn{ min-width: 50px; }
    .annStatus{ min-width: 50px; }
    #annDetailsCard img { width:28px;height:28px;object-fit:cover; }
    #annDocsWrap .badge { font-size: 0.8rem; }
    .audience-wrap .form-check { margin-right: .75rem; }
    .audience-course-row .badge { font-size: .85rem; }
    .disabled-action {
      opacity: 0.4 !important;
      pointer-events: none !important;
    }
    /* Small read-only badge under title */
    #ayReadOnlyBadge {
      font-size: 0.75rem;
    }
    h1 {
      letter-spacing: 0.08em;
      font-size: 1.6rem;
    }
    
    #manage-announcement .page-subtitle {
      font-size: 0.8rem;
    }

    #manage-announcement .nav-tabs .nav-link {
      font-weight: 500;
      font-size: 12px;
    }
    #manage-announcement .nav-tabs .nav-link i {
      margin-right: 0.35rem;
    }
    #manage-announcement .search-wrap {
      max-width: 340px;
    }
    #manage-announcement .table thead th {
      white-space: nowrap;
    }
    #manage-announcement .badge {
      font-size: 0.75rem;
    }
    #manage-announcement .view-toggle-group .btn {
      padding: 0.25rem 0.5rem;
      font-size: 0.875rem;
    }
  </style>
</head>

<script>
  // Optional fallback if you prefer globals (JS also checks <body data-*>)
  window.currentUserRole  = window.currentUserRole  || null;   // e.g. 'super-admin' | 'admin'
  window.currentUserCourse = window.currentUserCourse || null; // e.g. 'BSIT'
</script>

<!-- manage-announcement.html -->
<div class="container-fluid" id="manage-announcement">
  <!-- top header (Manage Users style) -->
  <div class="d-flex align-items-center justify-content-between mb-2">
    <div class="d-flex flex-column">
      <h1 class="mb-0 text-uppercase">MANAGE ANNOUNCEMENT</h1>
      <span class="page-subtitle text-muted" style="display: none;">
        Post, review, and manage campus-wide announcements for students and staff.
      </span>
      <!-- Read-only badge: JS will show/hide this by toggling .invisible -->
      <span id="ayReadOnlyBadge" class="text-muted mt-1 invisible">
          <strong><i class="bi bi-eye me-1">
          Viewing another Academic Year
         </i></strong>
      </span>
    </div>

    <!-- Right side info / placeholder for consistency some of these are hidden because they're just used for debugging -->
    <div class="text-end small">
      <div class="mb-1" style="display: none;">
        <span class="text-muted">Posting as:</span>
        <span id="whoAmI" class="badge bg-secondary">—</span>
      </div>
      <div class="text-muted" style="display: none;">Announcement &amp; notification management panel</div>
      <div>
        <span class="text-muted" style="display: none;">Current School Year:</span>
        <span id="currentSchoolYear" style="display: none;" class="badge bg-primary">—</span>
      </div>
    </div>
  </div>
  <hr class="mt-0 mb-3">

  <!-- filters -->
  <div class="d-flex justify-content-end gap-3 mt-2 flex-wrap">
    <div class="d-flex gap-2 align-items-center">
      <span class="text-muted">School Year:</span>
      <select id="announcementAySpanSelect" class="form-select form-select-sm" style="width:auto; min-width:140px;"></select>
    </div>
    <div class="d-flex gap-2 align-items-center">
      <span class="text-muted">Semester:</span>
      <select id="announcementActiveYearSelect" class="form-select form-select-sm" style="width:auto; min-width:110px;"></select>
    </div>
  </div>

  <div class="container mt-4">
    <div class="row g-3">
      <div class="col-12">
        <div class="card shadow-sm border-0">
          <div class="card-body">
            <!-- Tabs -->
            <ul class="nav nav-tabs justify-content-start" id="announcementTabs" role="tablist">
              <!-- Pending first -->
              <li class="nav-item">
                <button class="nav-link active" id="tabPendingAnnouncementTab" data-bs-toggle="tab" data-bs-target="#tabPendingAnnouncement" type="button" role="tab">
                  <i class="bi bi-hourglass-split"></i> Pending
                </button>
              </li>
              <!-- Active -->
              <li class="nav-item">
                <button class="nav-link" id="tabAllAnnouncementTab" data-bs-toggle="tab" data-bs-target="#tabAllAnnouncement" type="button" role="tab">
                  <i class="bi bi-megaphone"></i> Active
                </button>
              </li>
              <!-- Archived (new tab) -->
              <li class="nav-item">
                <button class="nav-link" id="tabArchivedAnnouncementTab" data-bs-toggle="tab" data-bs-target="#tabArchivedAnnouncement" type="button" role="tab">
                  <i class="bi bi-archive"></i> Archived
                </button>
              </li>
              <!-- Manage -->
              <li class="nav-item">
                <button class="nav-link" id="tabManageAnnouncementTab" data-bs-toggle="tab" data-bs-target="#tabManageAnnouncement" type="button" role="tab">
                  <i class="bi bi-gear"></i> Manage Announcements
                </button>
              </li>
              <!-- Rejected last -->
              <li class="nav-item">
                <button class="nav-link" id="tabRejectedAnnouncementTab" data-bs-toggle="tab" data-bs-target="#tabRejectedAnnouncement" type="button" role="tab">
                  <i class="bi bi-x-circle"></i> Rejected
                </button>
              </li>
            </ul>

            <div class="tab-content mt-3">
              <!-- Active Announcements Tab -->
              <div class="tab-pane fade" id="tabAllAnnouncement" role="tabpanel" aria-labelledby="tabAllAnnouncementTab">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                  <div class="search-wrap w-100 w-sm-50">
                    <div class="input-group input-group-sm">
                      <span class="input-group-text"><i class="bi bi-search"></i></span>
                      <input type="text"
                             class="form-control"
                             id="activeAnnouncementSearch"
                             placeholder="Search active announcements">
                    </div>
                  </div>
                  
                  <!-- View Toggle -->
                  <div class="btn-group btn-group-sm view-toggle-group" role="group">
                    <button type="button" class="btn btn-outline-secondary view-toggle-btn active" data-view="cards">
                      <i class="bi bi-grid-3x3-gap"></i> Cards
                    </button>
                    <button type="button" class="btn btn-outline-secondary view-toggle-btn" data-view="table">
                      <i class="bi bi-list"></i> Table
                    </button>
                  </div>
                </div>

                <!-- Cards view (default) -->
                <div id="allAnnouncementCardsView">
                  <div class="row g-3" id="activeAnnouncementCardsView"></div>
                </div>

                <!-- Table view -->
                <div class="table-responsive-sm d-none" id="allAnnouncementTableView">
                  <table class="table table-bordered table-striped w-100 align-middle">
                    <thead class="table-dark">
                      <tr>
                        <th style="width:80px;">ID</th>
                        <th>Title</th>
                        <th>Content</th>
                        <th>Status</th>
                        <th>Audience</th>
                        <th>Author</th>
                        <th style="min-width:140px;">Actions</th>
                      </tr>
                    </thead>
                    <tbody id="activeAnnouncementTableBody"></tbody>
                  </table>
                </div>

                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                  <div class="small text-muted" id="allAnnouncementPaginationInfo"></div>
                  <nav id="allAnnouncementPagination"></nav>
                </div>
              </div>

              <!-- Archived Announcements Tab -->
              <div class="tab-pane fade" id="tabArchivedAnnouncement" role="tabpanel" aria-labelledby="tabArchivedAnnouncementTab">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                  <div class="search-wrap w-100 w-sm-50">
                    <div class="input-group input-group-sm">
                      <span class="input-group-text"><i class="bi bi-search"></i></span>
                      <input type="text"
                             class="form-control"
                             id="archivedAnnouncementSearch"
                             placeholder="Search archived announcements">
                    </div>
                  </div>
                  
                  <!-- View Toggle -->
                  <div class="btn-group btn-group-sm view-toggle-group" role="group">
                    <button type="button" class="btn btn-outline-secondary view-toggle-btn active" data-view="cards">
                      <i class="bi bi-grid-3x3-gap"></i> Cards
                    </button>
                    <button type="button" class="btn btn-outline-secondary view-toggle-btn" data-view="table">
                      <i class="bi bi-list"></i> Table
                    </button>
                  </div>
                </div>

                <!-- Cards view -->
                <div id="ArchivedAnnouncementCardsView">
                  <div class="row g-3" id="archivedAnnouncementCardsView"></div>
                </div>

                <!-- Table view -->
                <div class="table-responsive-sm d-none" id="ArchivedAnnouncementTableView">
                  <table class="table table-bordered table-striped w-100 align-middle">
                    <thead class="table-dark">
                      <tr>
                        <th style="width:80px;">ID</th>
                        <th>Title</th>
                        <th>Content</th>
                        <th>Status</th>
                        <th>Audience</th>
                        <th>Author</th>
                        <th style="min-width:140px;">Actions</th>
                      </tr>
                    </thead>
                    <tbody id="archivedAnnouncementTableBody"></tbody>
                  </table>
                </div>

                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                  <div class="small text-muted" id="ArchivedAnnouncementPaginationInfo"></div>
                  <nav id="ArchivedAnnouncementPagination"></nav>
                </div>
              </div>

              <!-- Manage Announcements Tab (table + Add Announcement button here) -->
              <div class="tab-pane fade" id="tabManageAnnouncement" role="tabpanel" aria-labelledby="tabManageAnnouncementTab">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                  <div class="search-wrap w-100 w-sm-50">
                    <div class="input-group input-group-sm">
                      <span class="input-group-text"><i class="bi bi-search"></i></span>
                      <input type="text"
                             class="form-control"
                             id="announcementSearch"
                             placeholder="Search all announcements">
                    </div>
                  </div>

                   <!-- Actions -->
                    <div class="d-flex gap-2 align-items-center">
                      <div id="announcementDefaultActions">
                        <!-- Add Announcement button -->
                        <button class="btn btn-success btn" 
                                id="openAddAnnouncementBtn"
                                data-bs-toggle="modal"
                                data-bs-target="#addAnnouncementModal">
                          <i class="bi bi-plus-circle me-1"></i> Add Announcement
                        </button>
                      </div>
                      
                      <!-- Bulk Actions -->
                      <div id="announcementBulkActions" class="d-none">
                        <button class="btn btn-secondary btn-sm" id="bulkDeleteAnnouncements">
                          <i class="bi bi-archive"></i> Archive Selected
                        </button>
                      </div>
                    </div>
                </div>

                <div class="d-flex gap-2 align-items-center justify-content-end">
                    <!-- View Toggle -->
                    <div class="btn-group btn-group-sm view-toggle-group" role="group">
                      <button type="button" class="btn btn-outline-secondary view-toggle-btn" data-view="cards">
                        <i class="bi bi-grid-3x3-gap"></i> Cards
                      </button>
                      <button type="button" class="btn btn-outline-secondary view-toggle-btn active" data-view="table">
                        <i class="bi bi-list"></i> Table
                      </button>
                    </div>
                </div>
                <div style="height: 10px;">

                </div>

                <!-- Cards view for Manage -->
                <div class="d-none" id="ManageAnnouncementCardsView">
                  <div class="row g-3" id="manageAnnouncementCardsView"></div>
                </div>

                <!-- Table view for Manage -->
                <div class="table-responsive-sm" id="ManageAnnouncementTableView">
                  <table id="announcementTable" class="table table-bordered table-striped w-100 align-middle">
                    <thead class="table-dark">
                      <tr>
                        <!-- Select-all checkbox header is injected via JS -->
                        <th style="width:80px;">ID</th>
                        <th>Title</th>
                        <th>Content</th>
                        <th>Status</th>
                        <th>Audience</th>
                        <th>Author</th>
                        <th style="min-width:140px;">Actions</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>

                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                  <div class="small text-muted" id="ManageAnnouncementPaginationInfo"></div>
                  <nav id="ManageAnnouncementPagination"></nav>
                </div>
              </div>

              <!-- Pending (default active) -->
              <div class="tab-pane fade show active" id="tabPendingAnnouncement" role="tabpanel" aria-labelledby="tabPendingAnnouncementTab">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                  <div class="search-wrap w-100 w-sm-50">
                    <div class="input-group input-group-sm">
                      <span class="input-group-text"><i class="bi bi-search"></i></span>
                      <input type="text"
                             class="form-control"
                             id="pendingAnnouncementSearch"
                             placeholder="Search pending announcements">
                    </div>
                  </div>
                  
                  <!-- View Toggle -->
                  <div class="btn-group btn-group-sm view-toggle-group" role="group">
                    <button type="button" class="btn btn-outline-secondary view-toggle-btn active" data-view="cards">
                      <i class="bi bi-grid-3x3-gap"></i> Cards
                    </button>
                    <button type="button" class="btn btn-outline-secondary view-toggle-btn" data-view="table">
                      <i class="bi bi-list"></i> Table
                    </button>
                  </div>
                </div>

                <!-- Cards view -->
                <div id="PendingAnnouncementCardsView">
                  <div class="row g-3" id="pendingAnnouncementCardsView"></div>
                </div>

                <!-- Table view -->
                <div class="table-responsive-sm d-none" id="PendingAnnouncementTableView">
                  <table class="table table-bordered table-striped w-100 align-middle">
                    <thead class="table-dark">
                      <tr>
                        <th style="width:80px;">ID</th>
                        <th>Title</th>
                        <th>Content</th>
                        <th>Status</th>
                        <th>Audience</th>
                        <th>Author</th>
                        <th style="min-width:140px;">Actions</th>
                      </tr>
                    </thead>
                    <tbody id="pendingAnnouncementTableBody"></tbody>
                  </table>
                </div>

                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                  <div class="small text-muted" id="PendingAnnouncementPaginationInfo"></div>
                  <nav id="PendingAnnouncementPagination"></nav>
                </div>
              </div>

              <!-- Rejected (last) -->
              <div class="tab-pane fade" id="tabRejectedAnnouncement" role="tabpanel" aria-labelledby="tabRejectedAnnouncementTab">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                  <div class="search-wrap w-100 w-sm-50">
                    <div class="input-group input-group-sm">
                      <span class="input-group-text"><i class="bi bi-search"></i></span>
                      <input type="text"
                             class="form-control"
                             id="rejectedAnnouncementSearch"
                             placeholder="Search rejected announcements">
                    </div>
                  </div>
                  
                  <!-- View Toggle -->
                  <div class="btn-group btn-group-sm view-toggle-group" role="group">
                    <button type="button" class="btn btn-outline-secondary view-toggle-btn active" data-view="cards">
                      <i class="bi bi-grid-3x3-gap"></i> Cards
                    </button>
                    <button type="button" class="btn btn-outline-secondary view-toggle-btn" data-view="table">
                      <i class="bi bi-list"></i> Table
                    </button>
                  </div>
                </div>

                <!-- Cards view -->
                <div id="RejectedAnnouncementCardsView">
                  <div class="row g-3" id="rejectedAnnouncementCardsView"></div>
                </div>

                <!-- Table view -->
                <div class="table-responsive-sm d-none" id="RejectedAnnouncementTableView">
                  <table class="table table-bordered table-striped w-100 align-middle">
                    <thead class="table-dark">
                      <tr>
                        <th style="width:80px;">ID</th>
                        <th>Title</th>
                        <th>Content</th>
                        <th>Status</th>
                        <th>Audience</th>
                        <th>Author</th>
                        <th style="min-width:140px;">Actions</th>
                      </tr>
                    </thead>
                    <tbody id="rejectedAnnouncementTableBody"></tbody>
                  </table>
                </div>

                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                  <div class="small text-muted" id="RejectedAnnouncementPaginationInfo"></div>
                  <nav id="RejectedAnnouncementPagination"></nav>
                </div>
              </div>
            </div>
          </div> <!-- /.card-body -->
        </div> <!-- /.card -->
      </div>
    </div>
  </div>
</div>

<!-- Add Announcement Modal -->
<div class="modal fade" id="addAnnouncementModal" tabindex="-1" aria-labelledby="addAnnouncementModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-md">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title" id="addAnnouncementModalLabel">Add Announcement</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form id="addAnnouncementForm" enctype="multipart/form-data">
        <div class="modal-body d-flex flex-column gap-3">
          <div class="text-center">
            <center>
              <img id="announcementImagePreview" src="assets/images/image-add.png" class="img-fluid mb-2" style="max-height: 100px; object-fit: cover;" alt="Preview">
            </center>
            <input type="file" class="form-control mt-2" name="image" id="announcementImage" accept="image/*">
          </div>

          <div class="mb-3">
            <label for="announcementTitle" class="form-label">Title</label>
            <input type="text" class="form-control" id="announcementTitle" name="title" required>
          </div>

          <div class="mb-3">
            <label for="announcementDescription" class="form-label">Description</label>
            <textarea class="form-control" id="announcementDescription" name="description" rows="4" required></textarea>
          </div>

          <div class="mb-3">
            <label for="announcementCategory" class="form-label">Category</label>
            <select class="form-select" id="announcementCategory" name="category" required>
              <option selected disabled>-- Select Category --</option>
              <option value="School Event">School Event</option>
              <option value="Enrollment">Enrollment</option>
              <option value="Exam Schedule">Exam Schedule</option>
              <option value="Holiday">Holiday</option>
              <option value="General Announcement">General Announcement</option>
            </select>
          </div>

          <!-- Audience selection -->
          <div class="mb-2">
            <label class="form-label">Audience</label>
            <div class="audience-wrap d-flex align-items-center flex-wrap">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="audience_scope" id="audGeneral" value="general" checked>
                <label class="form-check-label" for="audGeneral">General (All)</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="audience_scope" id="audCourse" value="course">
                <label class="form-check-label" for="audCourse">Specific Course/Department</label>
              </div>
            </div>
          </div>

          <div id="audienceCourseRow" class="audience-course-row mb-2 d-none">
            <!-- JS fills this:
                 - Super-admin: a <select> of active courses
                 - Admin: shows a badge of their course + hidden input
            -->
            <div id="audienceCoursePicker"></div>
          </div>
        </div>

        <div class="modal-footer justify-content-between">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Post Announcement</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Announcement Modal -->
<div class="modal fade" id="editAnnouncementModal" tabindex="-1" aria-labelledby="editAnnouncementModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-md">
    <div class="modal-content">
      <form id="editAnnouncementForm" enctype="multipart/form-data">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title" id="editAnnouncementModalLabel">Edit Announcement</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3 text-center">
            <center>
              <img id="editAnnouncementPreview" src="assets/images/image-add.png" class="img-fluid rounded" style="max-height: 100px;">
            </center>
            <input type="file" class="form-control mt-2" name="image" id="editAnnouncementImage" accept="image/*">
          </div>

          <input type="hidden" name="id" id="editAnnouncementId">

          <div class="mb-3">
            <label for="editAnnouncementTitle" class="form-label">Title</label>
            <input type="text" class="form-control" name="title" id="editAnnouncementTitle" required>
          </div>

          <div class="mb-3">
            <label for="editAnnouncementDesc" class="form-label">Description</label>
            <textarea class="form-control" name="description" id="editAnnouncementDesc" rows="4" required></textarea>
          </div>

          <div class="mb-3" style="display: none;">
            <label for="editAnnouncementCategory" class="form-label">Category</label>
            <select class="form-select" id="editAnnouncementCategory" name="category" required>
              <option selected disabled>-- Select Category --</option>
              <option value="School Event">School Event</option>
              <option value="Enrollment">Enrollment</option>
              <option value="Exam Schedule">Exam Schedule</option>
              <option value="Holiday">Holiday</option>
              <option value="General Announcement">General Announcement</option>
            </select>
          </div>

          <div class="mb-3" style="display: none;">
            <label for="editAnnouncementStatus" class="form-label">Status</label>
            <select class="form-select" name="status" id="editAnnouncementStatus" required>
              <option value="Active">Active</option>
              <option value="Pending">Pending</option>
              <option value="Rejected">Rejected</option>
              <option value="Archived">Archived</option>
            </select>
          </div>

          <!-- Audience (Edit) -->
          <div class="mb-2" style="display: none;">
            <label class="form-label">Audience</label>
            <div class="audience-wrap d-flex align-items-center flex-wrap">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="audience_scope" id="editAudGeneral" value="general">
                <label class="form-check-label" for="editAudGeneral">General (All)</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="audience_scope" id="editAudCourse" value="course">
                <label class="form-check-label" for="editAudCourse">Specific Course/Department</label>
              </div>
            </div>
          </div>

          <div id="editAudienceCourseRow" class="audience-course-row mb-2">
            <div id="editAudienceCoursePicker"></div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Decline Reason Modal -->
<div class="modal fade" id="declineReasonModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title">Decline Announcement</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="declineReasonForm" class="modal-body">
        <input type="hidden" name="id" id="declineAnnId" />
        <div class="mb-2">
          <label class="form-label">Reason</label>
          <textarea class="form-control" name="reason" rows="4" placeholder="State the reason for declining…" required></textarea>
        </div>
      </form>
      <div class="modal-footer border-0">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-danger" id="confirmDeclineBtn" type="button">
          <i class="bi bi-x-circle"></i> Confirm Decline
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Generic Confirm Modal (replaces ugly browser confirm) -->
<div class="modal fade" id="genericConfirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title" id="genericConfirmTitle">Confirm Action</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0" id="genericConfirmMessage">Are you sure?</p>
      </div>
      <div class="modal-footer border-0 pt-0">
        <button type="button"
                class="btn btn-outline-secondary btn-sm"
                id="genericConfirmCancelBtn"
                data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button"
                class="btn btn-primary btn-sm"
                id="genericConfirmOkBtn">
          Yes
        </button>
      </div>
    </div>
  </div>
</div>
<!--openAddAnnouncementBtn-->